# Modeler Flow ハンズオン

本ハンズオンでは、クレジットカードの利用履歴と、顧客の属性、過去実際にキャンペーンを行った際の反応実績をサンプルデータとして使用し、予測モデルを作成します。
その後、現在の顧客情報を当てはめることで次回キャンペーンを行った場合の反応確度を予測します。
得られる予測結果を元に費用対効果を最大にするターゲットリストを作成します。

![image](./images/001.png)

本ハンズオンを通じて、1からこのストリーム([完成版ストリームファイル.str](./完成版ストリームファイル.str))を作成していきます。</br>
![image](./images/002.png)

## 1. プロジェクトの作成

Watson Studioのホーム画面で、**プロジェクトの作成**をクリックします。</br>
![image](./images/003.png)

プロジェクトの作成画面で、**空のプロジェクトを作成**をクリックします。</br>
![image](./images/004.png)

新規プロジェクトの画面で、名前欄に**Dojo**を入力します。</br>
画像の様に**①ストレージ・サービスの選択**と表示されている場合は、「追加」がリンクとなっていますのでクリックしてください。</br>
**ストレージ**と表示され、ストレージ名が既に入力されている場合は、右下の**作成**をクリックし、以降のストレージ作成の手順はスキップしてください。</br>
![image](./images/005.png)

Cloud Object Storageの作成画面が表示されたら、料金プランの中から、**ライトプラン**を選択し、**作成**をクリックします。</br>
※自動でプロジェクト作成画面に戻ります</br>
![image](./images/006.png)

先ほどのプロジェクト作成画面でストレージ欄にストレージ名が入っていることを確認して、**作成**をクリックします。</br>
![image](./images/007.png)

以下の様にプロジェクトのホーム画面が表示されたら、プロジェクトの作成完了です。</br>
![image](./images/008.png)

## 2. 資産の作成

**資産タブ**に切り替えて、**新規資産**をクリックします。</br>
![image](./images/009.png)

新規資産画面が表示されたら、検索フィールドに`モデラー・フロー`と入力し、Graphical canvasに表示される**モデラー・フロー**をクリックします。</br>
![image](./images/010.png)

SPSS Modeler Flowの作成画面が表示されたら、以下の通り設定し**Create**をクリックします。</br>
|フィールド|設定値|
|:--|:--|
|Name|Hands-on|
|環境定義|Default SPSS Modeler S(2 vCPU 8GB RAM)|

![image](./images/011.png)

少し待つと、SPSS Modeler Flowが利用できる様になります。</br>
![image](./images/012.png)

## 3. データの読み込み

このリポジトリをダウンロードし、[dataフォルダ](./data)に入っている以下のCSVファイルをすべて画面右側の点線で囲まれた部分にドラッグ＆ドロップします。</br>
|ファイル名|
|:--|
|顧客属性_実績.csv|
|顧客属性_予測.csv|
|反応_実績.csv|
|利用履歴_実績.csv|
|利用履歴_予測.csv|

![image](./images/013.png)

インポートパレットから、**データ資産**ノードをフロー・キャンバスにドラッグ＆ドロップします。</br>
![image](./images/014.png)

データ資産ノードを**ダブルクリック**または、右クリックし**開く**をクリックします。</br>
![image](./images/015.png)

データ資産の選択画面が表示されたら、**データ資産** > **利用履歴_実績.csv**と選択し、**選択**をクリックします。</br>
![image](./images/016.png)

何も変更せず**保存**をクリックします。</br>
![image](./images/017.png)

先ほど配置したノードの名前が**利用履歴_実績.csv**に自動で切り替わります。</br>
![image](./images/018.png)

同様の手順で、**顧客属性_実績.csv**と**反応_実績.csv**をフロー・キャンバスに追加します。</br>
![image](./images/019.png)

> 余裕のある方は、任意のノードを右クリックして、**プレビュー**を選択してみてください。</br>
> 読み込んだデータの中身を画面上で確認することができます。</br>
> ![image](./images/020.png)

## 4. データ加工（フラグ設定）

利用履歴データを顧客毎・用途毎に「使った/使わなかった」のフラグに変換し、縦持ちのデータを横持ちに簡単に変換します。</br>
![image](./images/021.png)

利用履歴(実績)のデータ型を読み込みます。</br>
フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**利用履歴_実績.csv　→　タイプ**と接続します。</br>
![image](./images/022.png)

> **<font color="blue">ノード同士の接続方法</font>**</br>
> 接続元のノードにマウスカーソルを置くと、**＞マーク**が表示されます。</br>
> **＞マーク**をドラッグし接続先のノードの上で離すとノードの接続ができます。</br>
> ![index](./images/023.gif)

タイプノードを**ダブルクリック**または、右クリックし**開く**をクリックします。</br>
**値の読み込み**をクリックし、読み込みが完了したら**保存**をクリックします。</br>
![image](./images/024.png)

フィールド操作パレットから、**フラグ設定**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ　→　フラグ設定**と接続します。</br>
![image](./images/025.png)

フラグ設定ノードを**ダブルクリック**または、右クリックし**開く**をクリックします。</br>
セット型フィールドは**用途**を選択し、**値の追加**をクリックします。</br>
![image](./images/026.png)

**全てのチェックボックスをON**にして**OK**をクリックします。</br>
![image](./images/027.png)

**集計キーをON**にして**列の追加**をクリックします。</br>
![image](./images/028.png)

**顧客番号をON**にして**OK**をクリックします。</br>
![image](./images/029.png)

**保存**をクリックします。</br>
![image](./images/030.png)

データの加工が意図した通りにできているか確認をします。</br>
出力パレットから、**表**ノードをフロー・キャンバスにドラッグ＆ドロップし、**フラグ設定 →　表**と接続します。</br>
![image](./images/031.png)

表ノードを右クリックし**実行**をクリックします。</br>
少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
![image](./images/032.png)

> 実行結果は、右上にある赤枠のアイコンをクリックし、出力タブに切り替えることで確認できます。</br>
> ![image](./images/033.png)

上手く顧客番号毎にどの用途で利用したかを横持ちのテーブルに変換できました。</br>
![image](./images/034.png)

## 5. データ加工（レコード結合）

先ほど作成した利用履歴フラグと、顧客属性・反応を顧客番号をキーに1つに結合します。</br>
![image](./images/035.png)

レコード操作パレットから、**マージ**ノードをフロー・キャンバスにドラッグ＆ドロップし、</br>
**フラグ設定　→　マージ**</br>
**顧客属性_実績.csv　→　マージ**</br>
**反応_実績.csv　→　マージ**</br>
と接続します。</br>
![image](./images/036.png)

マージノードを**ダブルクリック**します。</br>
マージ法に**キー**を選択し、**列の追加**をクリックします。</br>
![image](./images/037.png)

**顧客番号をON**にし、**OK**をクリックします。</br>
> それぞれの入力データに顧客番号が含まれているので複数表示されていますが、どれを選んでも問題ありません。

![image](./images/038.png)

**保存**をクリックします。</br>
![image](./images/039.png)

再度、マージノードによって得られるデータが意図したものか確認するため、一度表ノードに出力します。</br>
ノードを使い回しするため、先ほど使用した**フラグ設定と表の接続を解除**してください。</br>

> **<font color="blue">ノードの接続解除方法</font>**</br>
> 削除したい接続(→)を右クリックし、**削除**をクリックすると接続が解除できます。</br>
> ![image](./images/040.gif)

接続の解除ができたら、**マージ → 表**と接続します。</br>
![image](./images/041.png)

表ノードを右クリックし**実行**をクリックします。</br>
少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
![image](./images/042.png)

上手く顧客番号をキーに3つのテーブルを結合できました。</br>
![image](./images/043.png)

> マージは、キーとなる項目が必要です。</br>
> 各入力データでキーとなる項目名は同じである必要があります。</br>
> キー項目の名称が異なる場合はマージの前に項目名を変更するノード(フィルターノード)を使用します。</br>
> 例）cutomer_number → 顧客番号など

## 6. データ加工（特徴量抽出）

生データから、予測に役立つ特徴量を抽出します。</br>
生年月日そのものはキャンペーン反応に影響を及ぼさないが、年齢は影響を及ぼすだろう、というデータや業務に対する知識が必要です。</br>
適切なデータを利用して適切な特徴量を設定することが、予測分析の精度を向上するための最も有効な方法です。</br>
今回は、**生年月日から2022年3月1日時点での年齢**を算出します。</br>
![image](./images/044.png)

フィールド操作パレットから、**フィールド作成**ノードをフロー・キャンバスにドラッグ＆ドロップし、</br>
**マージ　→　フィールド作成**</br>
**フィールド作成　→　表**</br>
と接続し直します。</br>
> 既存の接続間にノードを追加したい場合、→の上に追加したいノードをドラッグ＆ドロップすることで簡単に追加することができます。</br>
> ![image](./images/045.gif)

![image](./images/046.png)

フィールド作成ノードをダブルクリックし、派生フィールド名に生成する列名として**年齢**と入力します。</br>
式の下にあるアイコンをクリックし、年齢を算出する式を作成します。</br>
![image](./images/047.png)

式ビルダーが表示されたら、**関数**をクリックし、**date_years_difference関数**をダブルクリックします。</br>
式に関数式が自動で挿入されます。</br>
![image](./images/048.png)

関数式に使用する1つ目の項目を選択します。</br>
**フィールド**をクリックし、**生年月日**をダブルクリックします。</br>
式に関数式が自動で挿入されます。</br>
![image](./images/049.png)

関数式に使用する2つ目の項目を入力します。</br>
**式のテキストボックス**をクリックし、``?`` を ``'2022-03-01'``に書き換えます。</br>
**OK**をクリックします。</br>
ノード名が自動で**年齢**に変わります。</br>
![image](./images/050.png)

> 式が下記画像の状態になっていることを確認してください。</br>
> ![image](./images/051.png)</br>
> 違っていた場合、手入力も可能なので以下の式へ修正してください。</br>
> ```text
> date_years_difference('生年月日', '2022-03-01')
> ```

表ノードを右クリックし実行をクリックします。</br>
少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
![image](./images/052.png)

生年月日から、2022年3月1日時点での年齢が算出できました。</br>
![image](./images/053.png)

> 今回の様な「生年月日から年齢を算出」などの算出処理では主に、**フィールド追加**ノードを利用します。</br>
> 式には、条件分岐などを設定して複雑な計算をすることも可能です。</br>

ここまでで、データの加工は完了です。

## 7. データ視覚化（データ検査）

集約・結合・特徴量抽出などがひとまず出来た段階でデータの可視化を行い、データ加工が適切か確認します。

出力パレットから、**データ検査**ノードをフロー・キャンバスにドラッグ＆ドロップし、**年齢　→　データ検査**と接続します。</br>
![image](./images/054.png)

データ検査ノードを右クリックし実行をクリックします。</br>
![image](./images/055.png)

少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
各項目のグラフ描画・基本的な統計量算出・欠損値の検査を網羅的に行い、想定外の値・分布・欠損値が確認できます。</br>
![image](./images/056.png)

## 8. データ視覚化（散布図）

次に、複数の項目間の関連を視覚化して確認します。</br>

グラフパレットから、**散布図**ノードをフロー・キャンバスにドラッグ＆ドロップし、**年齢　→　散布図**(ノード名が`?v. ?`になっています)と接続します。</br>
![image](./images/057.png)

散布図ノード(ノード名が`?v. ?`になっています)をダブルクリックし、散布図セクションでX軸Y軸に使用する項目を選択します。</br>

|Xフィールド|Yフィールド|
|:-|:-|
|年齢|年収|

![image](./images/058.png)

オーバーレイセクションで色に**キャンペーン反応**を選択し、**保存**をクリックします。</br>
![image](./images/059.png)

散布図ノード(ノード名が`年齢v. 年収`になっています)を右クリックし実行をクリックします。</br>
![image](./images/060.png)

少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
グラフからデータの抽出範囲を検討し、今回のキャンペーンのターゲットを20〜50代・年収200万以上に設定します。</br>
![image](./images/061.png)
![image](./images/062.png)

レコード操作パレットから、**選択**ノードを年齢ノードと表ノードの間にドラッグ＆ドロップし、</br>
**年齢　→　選択**</br>
**選択　→　表**</br>
と接続し直します。</br>
![image](./images/063.png)

条件に以下の式を貼り付けて、**保存**をクリックしてください。</br>
```text
'年齢' >= 20 and '年齢' <= 60 and '年収' >= 2000000 and '年収' <= 10000000
```
![image](./images/064.png)

> 余裕のある方は**年齢**→**年齢v. 年収**の間に**選択**ノードをコピーして、目的の領域が抽出できていることをグラフで確認してみてください。</br>
> ![image](./images/065.png)

## 9. パターン発見（アソシエーション）

膨大な組み合わせの項目間の関連性の中から、特徴的なルールを探し出します。</br>
併売分析、マーケットバスケット分析とも呼ばれ、主にクロスセリングに活用されます。

フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**選択　→　タイプ**と接続します。</br>
タイプノードをダブルクリックします。</br>
![image](./images/066.png)

**値の読み込み**をクリックし、ロールを以下の通り設定して**保存**をクリックします。</br>
|フィールド|ロール|
|:-|:-|
|顧客番号|レコードID|
|各用途_|両方|
|上記以外|なし|

![image](./images/067.png)

モデル作成パレットから、**Apriori**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ　→　Apriori**(ノード名が7フィールドになっています)と接続します。</br>
Aprioriノードを右クリックし、**実行**をクリックします。</br>
![image](./images/068.png)

Aprioriのモデルナゲットが生成されたら、右クリックし**モデルの表示**をクリックします。</br>
![image](./images/069.png)

モデルの詳細が表示されたら、**ルール**を選択します。</br>
1行目は以下のルールを表しています。</br>
|項目|説明|計算式|
|:-|:-|:-|
|サポート|全体の中で、通信販売・ETC・飲食店を利用する顧客は約10％|(前提条件を満たしたレコード÷全レコード)の値|
|確信度|通信販売・ETC・飲食店を利用する顧客のうち、宿泊施設も利用する顧客の割合は約86％|(前提条件と結果を満たしたレコード÷前提条件を満たしたレコード)の値|
|ルール・サポート|全体の中で、通信販売・ETC・飲食店・宿泊施設を利用する顧客は約9％|(前提条件と結果を満たしたレコード÷全レコード)の値|
|リフト|通信販売・ETC・飲食店という前提条件をつけない場合（63％）と比較して、宿泊施設の利用割合は1.36倍（86％）|(確信度÷結果を満たしたレコード÷全レコード)の値|
|デプロイアビリティー|通信販売・ETC・飲食店を利用し宿泊施設をまだ利用していない顧客が1.4％の倍率で通信販売・ETC・飲食店・宿泊施設を利用する顧客になる指標|((前提条件を満たしたレコード － 前提条件と結果を満たしたレコード) ÷ 全レコード) × 100の値|

![image](./images/070.png)

> 先ほどタイプノードで設定したロールは、モデルのルールに対して以下の様な意味を持ちます。</br>
> |ロール|説明|
> |:-|:-|
> |両方|前提条件と結果両方の候補|
> |入力|前提条件の候補|
> |ターゲット|結果の候補|

## 10. 分類（セグメンテーション）

利用履歴が似ているグループ(クラスター/セグメント)に自動的に分類します。</br>
クラスタリング、クラスター分析とも呼ばれ、顧客セグメント毎の施策立案などに活用されます。

フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**選択　→　タイプ**と接続します。</br>
タイプノードをダブルクリックします。</br>
![image](./images/071.png)

**値の読み込み**をクリックし、ロールを以下の通り設定して**保存**をクリックします。</br>
|フィールド|ロール|
|:-|:-|
|顧客番号|レコードID|
|各用途_|入力|
|上記以外|なし|

![image](./images/072.png)

モデル作成パレットから、**K-Means**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ　→　K-Means**と接続します。</br>
K-Meansノードを右クリックし、**実行**をクリックします。</br>
![image](./images/073.png)

K-Meansのモデルナゲットが生成されたら、右クリックし**モデルの表示**をクリックします。</br>
![image](./images/074.png)

モデルの詳細が表示されたら、**クラスター**を選択します。</br>
クラスター1は以下の様な特徴を持つことがわかります。</br>

- 旅行代理店は全く使わない
- ETCと宿泊施設はよく使う
- 百貨店はあまり使わない

![image](./images/075.png)

次に**クラスターの比較**を選択します。</br>
ここでは各用途毎に円の大きさでクラスター間の比較ができます。</br>

![image](./images/076.png)

## 11. 予測（教師あり学習）

教師あり学習の一種である、CART決定木を用いて予測モデルを作成します。
キャンペーン反応の確度が高いグループと低いグループに分岐していき、最終的に樹木の様に枝分かれした樹形図を作成します。

フィールド操作パレットから、**パーティション**ノードをフロー・キャンバスにドラッグ＆ドロップし、**選択　→　パーティション**と接続します。</br>
![image](./images/077.png)

フィールド操作パレットから、**タイプ**ノードをフロー・キャンバスにドラッグ＆ドロップし、**パーティション　→　タイプ**と接続します。</br>
![image](./images/078.png)

タイプノードをダブルクリックし、**値の読み込み**をクリックします。</br>
ロールを以下の通り設定して**保存**をクリックします。</br>
|フィールド|ロール|
|:-|:-|
|顧客番号|レコードID|
|生年月日|なし|
|キャンペーン反応|ターゲット|
|データ区分|パーティション|
|上記以外|入力|

![image](./images/079.png)

モデル作成パレットから、**C&R ツリー**ノードをフロー・キャンバスにドラッグ＆ドロップし、**タイプ→　C&R ツリー**と接続します。</br>
C&R ツリーノード(ノード名がキャンペーン反応になっています)を右クリックし、**実行**をクリックします。</br>
![image](./images/080.png)

C&R ツリーのモデルナゲットが生成されたら、右クリックし**モデルの表示**をクリックします。</br>
![image](./images/081.png)

モデルの詳細が表示されたら、**ツリー図**を選択します。</br>
赤枠で囲った部分は、「航空会社・旅行代理店を使わず、ETC・宿泊施設を使う顧客のキャンペーンの反応確度は56％である」といったルールの集まりになります。</br>
![image](./images/082.png)

## 12. 学習とテスト

先ほど作成した予測モデルの予測精度を検証します。</br>
パーティションノードによって実績データの一部を学習用に、残りをテスト用に分割して実施します。</br>
![image](./images/083.png)

出力パレットから、**データ検査**ノードをフロー・キャンバスにドラッグ＆ドロップし、**キャンペーン反応 →　データ検査**と接続します。</br>
![image](./images/084.png)

精度分析ノードをダブルクリックし、**一致行列**と**評価メトリック**のチェックを**ON**にして、**保存**をクリックします。</br>
![image](./images/085.png)

精度分析ノードを右クリックし、**実行**をクリックします。</br>
少し待つと、画面右側に出力の実行結果が表示されるので、一番上の出力結果をクリックします。</br>
![image](./images/086.png)

学習・テストの両方に対して、正答率などを表示できます。</br>
目標としている精度を達成しているかや、過学習（学習データに対しては予測精度が高いのに、テストデータに対しては精度が低いこと）が発生していないかの確認ができます。</br>
![image](./images/087.png)

## 13. オプション

フロー・キャンバスの処理内容をわかりやすくするため、コメントを追加することができます。</br>
**選択**ノードをダブルクリックして、右上の鉛筆マークをクリックし`年齢20代から50代、年収200万以上で条件抽出`と入力したら、**保存**をクリックします。</br>
こうすることで、フロー・キャンバス上のノード名が入力した内容に変わります。</br>
どの様な条件で抽出を行っているか、一目でわかる様になりました。</br>
![image](./images/088.png)

フロー・キャンバス上の何もない場所で右クリックをし、**新規コメント**をクリックするとテキストボックスが追加されるので、`学習：実績データから予測モデルを作成`と入力します。</br>
この様に、フロー・キャンバスのどの部分がどの様な処理を行うかを説明することができます。</br>
![image](./images/089.png)

以上で学習ステップは完了です。</br>
![image](./images/090.png)

## 14. 予測ステップ

学習ステップで行ったデータ加工と同じ処理を予測データに対して実施します。</br>

データの読み込みステップと同様の手順で、**利用履歴_予測.csv**と**顧客属性_予測.csv**をフロー・キャンバスに追加します。</br>
![image](./images/091.png)

学習ステップから、**タイプ**・**フラグ設定**・**マージ**・**年齢**・**選択**ノードをまとめてコピー＆貼り付けをします。</br>
![image](./images/092.png)

**利用履歴_予測.csv → タイプ**、**顧客属性_予測.csv → マージ**と接続します。</br>
![image](./images/093.png)

先ほどと同様に学習ステップから、モデルナゲットを全てコピー＆貼り付けをします。</br>
![image](./images/094.png)

出力パレットから、**表**ノードを3つフロー・キャンバスにドラッグ＆ドロップし、</br>
**生成　→　各モデルナゲット**</br>
**各モデルナゲット　→　表**</br>
と接続します。</br>
![image](./images/095.png)

各表ノードを右クリックし、**実行**をクリックし予測結果を見てみます。</br>
![image](./images/096.png)

予測結果のフィールドはモデルの手法によって自動で命名・追加されます。</br>
予測結果は画面への表示だけでなく、ファイルやRDBへ書き出すことも可能です。</br>

- パターン発見（アソシエーション）の予測結果
  各顧客がルールに当てはまり、かつ、おすすめ商品をまだ利用していない場合に
、確度が高い順に3つのおすすめ商品を提示しています。
  ![image](./images/097.png)

- 分類（セグメンテーション）の予測結果
  各顧客が分類されるクラスター（グループ）を提示しています。
  ![image](./images/098.png)

- 予測（教師あり学習）の予測結果
  各顧客がキャンペーンに反応する予測値とその確度を提示しています。
  予測値が**T**かつ確度が高い顧客から順に、次回キャンペーンのターゲットにすることで、限られたコストで最大限の効果をあげることができます。
  ![image](./images/099.png)

以上で本ハンズオンは終了です。お疲れ様でした。
